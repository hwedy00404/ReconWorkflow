name: ğŸ“¸ Bulk Gowitness Screenshots

on:
  workflow_dispatch:
    inputs:
      urls_file:
        description: 'URLs file name (example: urls.txt)'
        required: true
        default: 'urls.txt'
        type: string
      threads:
        description: 'Number of threads (1-20)'
        required: false
        default: '10'
        type: string
      delay:
        description: 'Delay time in seconds'
        required: false
        default: '3'
        type: string
      timeout:
        description: 'Wait time in seconds'
        required: false
        default: '30'
        type: string

jobs:
  screenshot_job:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ› ï¸ Setup Go Environment
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      
      - name: ğŸŒ Install Chromium
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser
          echo "âœ… Chromium installed at: $(which chromium-browser)"
      
      - name: â¬‡ï¸ Install Gowitness
        run: go install github.com/sensepost/gowitness@latest
      
      - name: âœ… Verify URLs File
        run: |
          if [ ! -f "${{ github.event.inputs.urls_file || 'urls.txt' }}" ]; then
            echo "âŒ The file ${{ github.event.inputs.urls_file || 'urls.txt' }} does not exist!"
            exit 1
          fi
          echo "âœ… File found"
          echo "ğŸ“Š Number of URLs:"
          wc -l < "${{ github.event.inputs.urls_file || 'urls.txt' }}"
      
      - name: ğŸƒ Run Gowitness Scan
        run: |
          export PATH=$PATH:$(go env GOPATH)/bin
          
          # Run Gowitness with a write in database
          gowitness scan file \
            -f "${{ github.event.inputs.urls_file || 'urls.txt' }}" \
            --write-db \
            --screenshot-format png \
            --threads ${{ github.event.inputs.threads || '10' }} \
            --delay ${{ github.event.inputs.delay || '3' }} \
            --timeout ${{ github.event.inputs.timeout || '30' }}
          
          echo "âœ… Filming Completed"
          
          # Check for a folder of screenshots and count photos
          if [ -d "screenshots" ]; then
            echo "âœ… Available screenshots folder"
            # Count all kinds of photos
            PNG_COUNT=$(ls -1 screenshots/*.png 2>/dev/null | wc -l || echo 0)
            JPEG_COUNT=$(ls -1 screenshots/*.jpeg 2>/dev/null | wc -l || echo 0)
            JPG_COUNT=$(ls -1 screenshots/*.jpg 2>/dev/null | wc -l || echo 0)
            TOTAL=$((PNG_COUNT + JPEG_COUNT + JPG_COUNT))
            echo "ğŸ“Š Total Images: $TOTAL"
            echo "   - PNG: $PNG_COUNT"
            echo "   - JPEG: $JPEG_COUNT"
            echo "   - JPG: $JPG_COUNT"
            echo ""
            echo "ğŸ“¸ Folder Contents:"
            ls -lh screenshots/
          else
            echo "âŒ Screenshots folder does not exist!"
            echo "ğŸ“‚ Existing folders:"
            ls -la
          fi
      
      - name: ğŸ“‹ Generate Summary Report
        run: |
          # Calculate the number of images of each type
          PNG_COUNT=$(ls -1 screenshots/*.png 2>/dev/null | wc -l || echo 0)
          JPEG_COUNT=$(ls -1 screenshots/*.jpeg 2>/dev/null | wc -l || echo 0)
          JPG_COUNT=$(ls -1 screenshots/*.jpg 2>/dev/null | wc -l || echo 0)
          TOTAL=$((PNG_COUNT + JPEG_COUNT + JPG_COUNT))
          
          echo "# ğŸ“¸ Survey Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**File Used:** \`${{ github.event.inputs.urls_file || 'urls.txt' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Number of URLs:** $(wc -l < ${{ github.event.inputs.urls_file || 'urls.txt' }})" >> $GITHUB_STEP_SUMMARY
          echo "**Total Images:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "  - ğŸŸ¦ PNG: $PNG_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "  - ğŸŸ¨ JPEG: $JPEG_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "  - ğŸŸ§ JPG: $JPG_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "**Threads:** ${{ github.event.inputs.threads || '10' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Delay:** ${{ github.event.inputs.delay || '3' }}s" >> $GITHUB_STEP_SUMMARY
          echo "**Timeout:** ${{ github.event.inputs.timeout || '30' }}s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“¥ Photos saved in Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Download the images from the **Artifacts** section at the bottom of the page" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ“¤ Upload Screenshots as Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gowitness-screenshots-${{ github.run_number }}
          path: |
            screenshots/*.png
            screenshots/*.jpg
            screenshots/*.jpeg
          if-no-files-found: warn
          retention-days: 30
      
      - name: ğŸ“¤ Upload Database (Optional)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gowitness-database-${{ github.run_number }}
          path: gowitness.sqlite3
          if-no-files-found: ignore
          retention-days: 7

      - name: ğŸ“± Send Telegram Notification
        if: always()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Counting the number of images
          PNG_COUNT=$(ls -1 screenshots/*.png 2>/dev/null | wc -l || echo 0)
          JPEG_COUNT=$(ls -1 screenshots/*.jpeg 2>/dev/null | wc -l || echo 0)
          JPG_COUNT=$(ls -1 screenshots/*.jpg 2>/dev/null | wc -l || echo 0)
          TOTAL=$((PNG_COUNT + JPEG_COUNT + JPG_COUNT))
          URLS_COUNT=$(wc -l < ${{ github.event.inputs.urls_file || 'urls.txt' }})
          
          # Determine Workflow Status
          if [ "${{ job.status }}" == "success" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="Succeed"
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="It failed"
          fi
          
          # Create the message
          MESSAGE="ğŸ¤– *Gowitness Workflow*%0A%0A"
          MESSAGE+="${STATUS_EMOJI} *Status:* ${STATUS_TEXT}%0A%0A"
          MESSAGE+="ğŸ“Š *Statistics:*%0A"
          MESSAGE+="â€¢ File: \`${{ github.event.inputs.urls_file || 'urls.txt' }}\`%0A"
          MESSAGE+="â€¢ Number of URLs: ${URLS_COUNT}%0A"
          MESSAGE+="â€¢ Photos taken: ${TOTAL}%0A"
          MESSAGE+="  - PNG: ${PNG_COUNT}%0A"
          MESSAGE+="  - JPEG: ${JPEG_COUNT}%0A"
          MESSAGE+="  - JPG: ${JPG_COUNT}%0A%0A"
          MESSAGE+="âš™ï¸ *Settings:*%0A"
          MESSAGE+="â€¢ Threads: ${{ github.event.inputs.threads || '10' }}%0A"
          MESSAGE+="â€¢ Delay: ${{ github.event.inputs.delay || '3' }}s%0A"
          MESSAGE+="â€¢ Timeout: ${{ github.event.inputs.timeout || '30' }}s%0A%0A"
          MESSAGE+="ğŸ”— [width Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          # Send Notification
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true
